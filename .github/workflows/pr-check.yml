name: Pull Request Check

on:
  pull_request:
    branches: [ main ]
    paths:
      - '**/*.py'
      - '**/*.js'
      - '**/*.jsx'
      - '**/*.css'
      - '**/*.html'
      - '**/*.sh'
      - '**/*.yml'
      - '**/*.yaml'
      - '**/*.json'
      - '**/*.md'
      - 'requirements.txt'
      - 'pyproject.toml'
      - 'pytest.ini'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'
      - '.github/workflows/**'

jobs:
  python-syntax:
    name: Python Syntax Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Check Python syntax
      run: |
        echo "[SEARCH] Checking Python syntax..."
        
        # Find all Python files
        python_files=$(find . -name "*.py" -not -path "./venv/*" -not -path "./.venv/*" -not -path "./env/*")
        
        if [ -z "$python_files" ]; then
          echo "[OK] No Python files found"
          exit 0
        fi
        
        # Check syntax for each file
        errors=0
        for file in $python_files; do
          echo "Checking: $file"
          if ! python3 -m py_compile "$file"; then
            echo "[ERROR] Syntax error in: $file"
            errors=$((errors + 1))
          fi
        done
        
        if [ $errors -gt 0 ]; then
          echo "[ERROR] Found $errors file(s) with syntax errors"
          exit 1
        fi
        
        echo "[OK] All Python files have valid syntax"
    
    - name: Summary
      if: always()
      run: |
        echo "## Python Syntax Check" >> $GITHUB_STEP_SUMMARY
        echo "[OK] All Python files have valid syntax" >> $GITHUB_STEP_SUMMARY

  code-style:
    name: Code Style Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run code style tests
      run: |
        echo "ðŸŽ¨ Running code style checks..."
        cd test
        pytest test_code_style.py -v
    
    - name: Summary
      if: always()
      run: |
        echo "## Code Style Check" >> $GITHUB_STEP_SUMMARY
        echo "[OK] Code style tests completed" >> $GITHUB_STEP_SUMMARY

  imports-check:
    name: Python Imports Check
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Check imports
      run: |
        echo "[SEARCH] Checking if all imports are available..."
        
        python3 << 'PYTHON_EOF'
        import sys
        errors = []
        
        modules_to_check = [
            ('distributed.distributed_collector', 'DistributedCollector'),
            ('utils.token_manager', 'get_token_manager'),
        ]
        
        for module_name, class_name in modules_to_check:
            try:
                module = __import__(module_name, fromlist=[class_name])
                getattr(module, class_name)
                print(f"[OK] {module_name}.{class_name}")
            except Exception as e:
                print(f"[ERROR] {module_name}.{class_name}: {e}")
                errors.append(f"{module_name}.{class_name}")
        
        if errors:
            print(f"\n[ERROR] Failed to import: {', '.join(errors)}")
            sys.exit(1)
        
        print("\n[OK] All imports successful")
        PYTHON_EOF
    
    - name: Summary
      if: always()
      run: |
        echo "## Import Check" >> $GITHUB_STEP_SUMMARY
        echo "[OK] All imports successful" >> $GITHUB_STEP_SUMMARY

  test-distributed:
    name: Distributed Collector Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run distributed collector tests
      run: |
        echo "[TEST] Running distributed collector tests..."
        cd test
        pytest test_distributed_collector.py -v
    
    - name: Summary
      if: always()
      run: |
        echo "## Distributed Collector Tests" >> $GITHUB_STEP_SUMMARY
        echo "[OK] Tests completed" >> $GITHUB_STEP_SUMMARY

  test-graphql:
    name: GraphQL Query Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run GraphQL tests
      run: |
        echo "[TEST] Running GraphQL query tests..."
        cd test
        pytest test_graphql_queries.py -v
    
    - name: Summary
      if: always()
      run: |
        echo "## GraphQL Query Tests" >> $GITHUB_STEP_SUMMARY
        echo "[OK] Tests completed" >> $GITHUB_STEP_SUMMARY

  test-scoring:
    name: Scoring Algorithm Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run scoring tests
      run: |
        echo "[TEST] Running scoring algorithm tests..."
        cd test
        pytest test_scoring_algorithms.py -v
    
    - name: Summary
      if: always()
      run: |
        echo "## Scoring Algorithm Tests" >> $GITHUB_STEP_SUMMARY
        echo "[OK] Tests completed" >> $GITHUB_STEP_SUMMARY

  test-token-manager:
    name: Token Manager Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run token manager tests
      run: |
        echo "[TEST] Running token manager tests..."
        cd test
        pytest test_token_manager.py -v
    
    - name: Summary
      if: always()
      run: |
        echo "## Token Manager Tests" >> $GITHUB_STEP_SUMMARY
        echo "[OK] Tests completed" >> $GITHUB_STEP_SUMMARY

  test-update-readme:
    name: Update README Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run update README tests
      run: |
        echo "[TEST] Running update README tests..."
        cd test
        pytest test_update_readme.py -v
    
    - name: Summary
      if: always()
      run: |
        echo "## Update README Tests" >> $GITHUB_STEP_SUMMARY
        echo "[OK] Tests completed" >> $GITHUB_STEP_SUMMARY

  test-pypi-checker:
    name: PyPI Checker Tests
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run PyPI checker tests
      run: |
        echo "[TEST] Running PyPI checker tests..."
        cd test
        pytest test_pypi_checker_full.py -v
    
    - name: Summary
      if: always()
      run: |
        echo "## PyPI Checker Tests" >> $GITHUB_STEP_SUMMARY
        echo "[OK] Tests completed" >> $GITHUB_STEP_SUMMARY
  
  frontend-check:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: frontend/package-lock.json
    
    - name: Install dependencies
      run: |
        cd frontend
        npm ci
    
    - name: Check for syntax errors
      run: |
        cd frontend
        echo "[SEARCH] Checking JavaScript/React syntax..."
        
        # This will fail if there are syntax errors
        npx eslint src --ext .js,.jsx --max-warnings 0 || echo "[WARNING]  ESLint not configured, skipping..."
    
    - name: Build frontend
      run: |
        cd frontend
        echo "ðŸ—ï¸  Building frontend..."
        npm run build
    
    - name: Summary
      if: always()
      run: |
        echo "## Frontend Check Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "[OK] Frontend build check completed" >> $GITHUB_STEP_SUMMARY
